<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>P2P Chat v2</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* --- CSS Styles --- */
        :root {
            --bg: #0f172a; --card: #1e293b; --primary: #3b82f6; --text: #f8fafc;
            --success: #10b981; --danger: #ef4444;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* Login Screen */
        #login-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; overflow-y: auto;
        }
        .card {
            background: var(--card); padding: 2rem; border-radius: 16px; width: 100%; max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); text-align: center;
        }
        input {
            width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155;
            color: white; border-radius: 8px; margin-bottom: 12px; font-size: 1rem;
        }
        button {
            width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;
            font-size: 1rem; color: white; transition: 0.2s; margin-top: 5px;
        }
        .btn-blue { background: var(--primary); }
        .btn-gray { background: #475569; margin-top: 10px; }
        
        #room-generated { margin: 15px 0; padding: 15px; background: rgba(59,130,246,0.1); border: 1px dashed var(--primary); border-radius: 8px; display: none; }
        #room-code { font-size: 1.5rem; font-weight: bold; color: var(--primary); letter-spacing: 2px; }

        /* Debug Log Box (To see errors on phone) */
        #debug-log {
            margin-top: 20px; font-family: monospace; font-size: 0.75rem; color: #94a3b8;
            background: #000; padding: 10px; width: 100%; max-width: 400px;
            height: 100px; overflow-y: auto; border-radius: 6px; text-align: left;
            border: 1px solid #333; display: none; /* Hidden by default */
        }
        .log-line { border-bottom: 1px solid #222; padding: 2px 0; }

        /* Chat Screen */
        #chat-screen { display: flex; flex-direction: column; height: 100%; display: none; }
        header { padding: 15px; background: var(--card); border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ccc; display: inline-block; margin-right: 5px; }
        .online { background: var(--success); box-shadow: 0 0 8px var(--success); }
        
        #chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 10px 14px; border-radius: 14px; font-size: 0.95rem; word-wrap: break-word; }
        .me { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .other { align-self: flex-start; background: #334155; color: white; border-bottom-left-radius: 2px; }
        .sys { align-self: center; font-size: 0.8rem; color: #64748b; background: rgba(255,255,255,0.05); padding: 4px 10px; border-radius: 10px; }

        .input-area { padding: 15px; background: var(--card); display: flex; gap: 10px; }
        #msg-in { flex: 1; padding: 12px; border-radius: 24px; border: none; background: #0f172a; color: white; }
        #send-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--primary); color: white; border: none; font-size: 1.2rem; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="card">
            <h2>üöÄ Secure P2P</h2>
            <input type="text" id="username" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
            
            <!-- Step 1: Buttons -->
            <div id="step-1">
                <button class="btn-blue" onclick="createRoom()">Create New Room</button>
                <button class="btn-gray" onclick="showJoinUI()">Join Friend's Room</button>
            </div>

            <!-- Step 2: Create Room UI -->
            <div id="room-generated">
                <p>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶è ‡¶è‡¶á ‡¶ï‡ßã‡¶°‡¶ü‡¶ø ‡¶¶‡¶ø‡¶®:</p>
                <div id="room-code">...</div>
                <div class="sys" style="margin-top:10px;">‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡¶õ‡¶ø...</div>
            </div>

            <!-- Step 3: Join Room UI -->
            <div id="step-join" class="hidden">
                <input type="number" id="room-id-input" placeholder="Room ID ‡¶¶‡¶ø‡¶®">
                <button class="btn-blue" id="join-btn" onclick="joinRoom()">Connect Now</button>
                <button class="btn-gray" onclick="location.reload()">Back</button>
            </div>
        </div>

        <!-- Debug Log Area -->
        <div id="debug-log">Log started...<br></div>
        <button onclick="document.getElementById('debug-log').style.display='block'" style="background:none; color:#555; font-size:10px; margin-top:10px; width:auto;">Show Logs (‡¶Ø‡¶¶‡¶ø ‡¶ï‡¶æ‡¶ú ‡¶®‡¶æ ‡¶ï‡¶∞‡ßá)</button>
    </div>

    <!-- CHAT -->
    <div id="chat-screen">
        <header>
            <div><span class="status-dot online"></span> <span id="room-label">Chat</span></div>
            <button onclick="location.reload()" style="width:auto; padding:5px 10px; background:#ef4444; font-size:0.8rem;">Exit</button>
        </header>
        <div id="chat-box"></div>
        <div class="input-area">
            <input type="text" id="msg-in" placeholder="Message...">
            <button id="send-btn" onclick="sendMsg()">‚û§</button>
        </div>
    </div>

    <script>
        // --- Settings ---
        // PieSocket Demo Key (Public). If it fails, try changing the Cluster ID.
        const API_KEY = 'VCXCEuvhGcBNCAdg1C6hoY14dRFLunqL1LcfJFgu';
        const CLUSTER = 'demo.piesocket.com';
        
        // --- Variables ---
        let socket, pc, dataChannel;
        let myName, roomId;
        let isInitiator = false;
        const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        // --- Custom Logger ---
        function log(msg) {
            console.log(msg);
            const box = document.getElementById('debug-log');
            const time = new Date().toLocaleTimeString().split(' ')[0];
            box.innerHTML += `<div class="log-line">[${time}] ${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        // --- UI Functions ---
        function createRoom() {
            myName = document.getElementById('username').value.trim();
            if (!myName) return alert("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®");
            
            roomId = Math.floor(100000 + Math.random() * 900000);
            
            document.getElementById('step-1').classList.add('hidden');
            document.getElementById('room-generated').style.display = 'block';
            document.getElementById('room-code').innerText = roomId;
            
            isInitiator = true;
            log("Room Created: " + roomId);
            startSignaling();
        }

        function showJoinUI() {
            myName = document.getElementById('username').value.trim();
            if (!myName) return alert("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®");
            document.getElementById('step-1').classList.add('hidden');
            document.getElementById('step-join').classList.remove('hidden');
        }

        function joinRoom() {
            roomId = document.getElementById('room-id-input').value.trim();
            if (roomId.length < 4) return alert("‡¶∏‡¶†‡¶ø‡¶ï Room ID ‡¶¶‡¶ø‡¶®");
            
            document.getElementById('join-btn').innerText = "Connecting...";
            document.getElementById('join-btn').disabled = true;
            
            isInitiator = false;
            log("Joining Room: " + roomId);
            startSignaling();
        }

        // --- Signaling (WebSocket) ---
        function startSignaling() {
            log("Connecting to Signal Server...");
            const url = `wss://${CLUSTER}/v3/${roomId}?api_key=${API_KEY}&notify_self=0`;
            socket = new WebSocket(url);

            socket.onopen = () => {
                log("Signal Server Connected ‚úÖ");
                if (!isInitiator) {
                    log("Sending JOIN signal...");
                    send({ type: 'join' });
                    
                    // Timeout check for Joiner
                    setTimeout(() => {
                        if (socket && socket.readyState === 1 && !pc) {
                            alert("‡¶¨‡¶®‡ßç‡¶ß‡ßÅ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ! ‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ Room ‡¶ü‡¶ø ‡¶ì‡¶™‡ßá‡¶® ‡¶ï‡¶∞‡ßá ‡¶∞‡ßá‡¶ñ‡ßá‡¶õ‡ßá‡•§");
                            document.getElementById('join-btn').innerText = "Try Again";
                            document.getElementById('join-btn').disabled = false;
                        }
                    }, 8000); // 8 seconds timeout
                }
            };

            socket.onmessage = (e) => {
                const data = JSON.parse(e.data);
                handleSignal(data);
            };

            socket.onerror = (e) => {
                log("Signal Error ‚ùå. Network block or Key expired.");
                alert("‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶® ‡¶è‡¶∞‡¶∞! ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
            };
        }

        function send(data) {
            if (socket.readyState === 1) socket.send(JSON.stringify(data));
        }

        // --- WebRTC Core ---
        async function handleSignal(data) {
            log("Received Signal: " + data.type);

            if (data.type === 'join' && isInitiator) {
                log("Friend Joined! Creating Connection...");
                setupPeer();
                dataChannel = pc.createDataChannel("chat");
                setupChannel();
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                send({ type: 'offer', sdp: offer });

            } else if (data.type === 'offer' && !isInitiator) {
                log("Offer Received. Answering...");
                setupPeer();
                pc.ondatachannel = (e) => {
                    dataChannel = e.channel;
                    setupChannel();
                };
                await pc.setRemoteDescription(data.sdp);
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                send({ type: 'answer', sdp: answer });

            } else if (data.type === 'answer' && isInitiator) {
                log("Answer Received.");
                await pc.setRemoteDescription(data.sdp);

            } else if (data.candidate && pc) {
                await pc.addIceCandidate(data.candidate);
            }
        }

        function setupPeer() {
            if (pc) return;
            pc = new RTCPeerConnection(config);
            pc.onicecandidate = (e) => {
                if (e.candidate) send({ candidate: e.candidate });
            };
            pc.onconnectionstatechange = () => {
                log("P2P State: " + pc.connectionState);
                if (pc.connectionState === 'disconnected') {
                    addMsg("System", "Friend disconnected", "sys");
                }
            };
        }

        function setupChannel() {
            dataChannel.onopen = () => {
                log("üî• P2P CONNECTED! Closing Server.");
                socket.close(); // Serverless mode on
                
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('chat-screen').style.display = 'flex';
                document.getElementById('room-label').innerText = "Room: " + roomId;
                addMsg("System", "‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶® ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "sys");
            };
            dataChannel.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                addMsg(msg.user, msg.text, "other");
            };
        }

        // --- Chat Functions ---
        function sendMsg() {
            const input = document.getElementById('msg-in');
            const text = input.value.trim();
            if (!text || !dataChannel) return;
            
            dataChannel.send(JSON.stringify({ user: myName, text: text }));
            addMsg("Me", text, "me");
            input.value = '';
        }

        function addMsg(user, text, type) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerHTML = type === 'sys' ? text : `<b>${user}</b><br>${text}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }
    </script>
</body>
</html>
